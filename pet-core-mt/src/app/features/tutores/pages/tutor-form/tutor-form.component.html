<div class="container-responsive py-10">
  <div class="mb-6">
    <button
      pButton
      label="Voltar"
      icon="pi pi-arrow-left"
      (click)="cancel()"
      class="mb-4 w-full sm:w-auto"
    ></button>
  </div>

  <div class="max-w-2xl mx-auto">
    <p-card>
      <ng-template pTemplate="header">
        <div class="p-4">
          <h1 class="text-3xl font-bold text-gray-900">
            {{ tutorId() ? 'Editar Tutor' : 'Novo Tutor' }}
          </h1>
        </div>
      </ng-template>

      @if (isLoading() && tutorId()) {
        <div class="text-center py-12">
          <p class="text-gray-600">Carregando dados do tutor...</p>
        </div>
      } @else {
        <form [formGroup]="tutorForm" (ngSubmit)="onSubmit()" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-2 md:col-span-2">
              <label for="nome" class="field-label">
                Nome Completo <span class="text-red-500">*</span>
              </label>
              <input
                id="nome"
                type="text"
                pInputText
                formControlName="nome"
                class="w-full"
                [class.border-red-500]="tutorForm.get('nome')?.invalid && tutorForm.get('nome')?.touched"
                placeholder="Digite o nome completo"
              />
              @if (tutorForm.get('nome')?.invalid && tutorForm.get('nome')?.touched) {
                <span class="field-error">
                  @if (tutorForm.get('nome')?.errors?.['required']) {
                    Nome é obrigatório
                  }
                </span>
              }
            </div>

            <div class="space-y-2">
              <label for="telefone" class="field-label">
                Telefone <span class="text-red-500">*</span>
              </label>
              <input
                id="telefone"
                type="text"
                pInputText
                formControlName="telefone"
                appPhoneMask
                class="w-full"
                [class.border-red-500]="tutorForm.get('telefone')?.invalid && tutorForm.get('telefone')?.touched"
                placeholder="(00) 00000-0000"
                maxlength="15"
              />
              @if (tutorForm.get('telefone')?.invalid && tutorForm.get('telefone')?.touched) {
                <span class="field-error">
                  @if (tutorForm.get('telefone')?.errors?.['required']) {
                    Telefone é obrigatório
                  }
                </span>
              }
            </div>

            <div class="space-y-2">
              <label for="email" class="field-label">Email</label>
              <input
                id="email"
                type="email"
                pInputText
                formControlName="email"
                class="w-full"
                [class.border-red-500]="tutorForm.get('email')?.invalid && tutorForm.get('email')?.touched"
                placeholder="email@exemplo.com"
              />
              @if (tutorForm.get('email')?.invalid && tutorForm.get('email')?.touched) {
                <span class="field-error">
                  @if (tutorForm.get('email')?.errors?.['email']) {
                    Email inválido
                  }
                </span>
              }
            </div>

            <div class="space-y-2 md:col-span-2">
              <label for="endereco" class="field-label">Endereço</label>
              <input
                id="endereco"
                type="text"
                pInputText
                formControlName="endereco"
                class="w-full"
                placeholder="Digite o endereço completo"
              />
            </div>

            <div class="space-y-2">
              <label for="cpf" class="field-label">CPF</label>
              <input
                id="cpf"
                type="text"
                pInputText
                formControlName="cpf"
                class="w-full"
                appCpfMask
                maxlength="14"
                inputmode="numeric"
                placeholder="000.000.000-00"
              />
            </div>

            <div class="space-y-2 md:col-span-2">
              <label for="foto" class="field-label">Foto</label>
              <div class="flex flex-col gap-4">
                @if (previewUrl()) {
                  <div class="w-full h-64 bg-gray-200 rounded-xl overflow-hidden ring-1 ring-gray-200">
                    <img [src]="previewUrl()" alt="Preview" class="w-full h-64 object-cover" />
                  </div>
                }
                <input
                  id="foto"
                  type="file"
                  accept="image/*"
                  (change)="onFileSelected($event)"
                  class="file-input"
                />
              </div>
            </div>
          </div>

          <div class="pt-6 border-t border-gray-200">
            <div class="flex flex-col gap-3 sm:flex-row sm:justify-between sm:items-center mb-4">
              <h2 class="text-xl font-semibold text-gray-900">Pets vinculados</h2>
              <button
                type="button"
                pButton
                label="Vincular Pet"
                icon="pi pi-plus"
                (click)="openLinkDialog()"
                [disabled]="isLoading() || isUploading()"
                class="p-button-sm w-full sm:w-auto"
              ></button>
            </div>

            @if (linkedPets().length) {
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                @for (pet of linkedPets(); track pet.id) {
                  <div class="p-4 bg-white rounded-xl ring-1 ring-gray-200/70">
                    <div class="flex items-start gap-4">
                      @if (pet.foto?.url) {
                        <img
                          [src]="pet.foto?.url"
                          [alt]="pet.nome"
                          class="w-16 h-16 rounded-full object-cover"
                        />
                      }
                      <div class="flex-1">
                        <h3 class="font-semibold text-gray-900 mb-1">{{ pet.nome }}</h3>
                        <p class="text-sm text-gray-600 mb-1">
                          <span class="font-medium">Raça:</span> {{ pet.raca }}
                        </p>
                        @if (pet.idade !== undefined && pet.idade !== null) {
                          <p class="text-sm text-gray-600 mb-3">
                            <span class="font-medium">Idade:</span> {{ pet.idade }} {{ pet.idade === 1 ? 'ano' : 'anos' }}
                          </p>
                        }
                        <button
                          type="button"
                          pButton
                          label="Desvincular"
                          icon="pi pi-times"
                          (click)="unlinkPet(pet.id)"
                          [disabled]="isLoading() || isUploading()"
                          class="p-button-sm p-button-danger"
                        ></button>
                      </div>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <p class="text-gray-600">Nenhum pet vinculado ainda.</p>
            }
          </div>

          <div class="flex flex-col-reverse sm:flex-row gap-3 justify-end pt-4">
            <button
              type="button"
              pButton
              label="Cancelar"
              (click)="cancel()"
              [disabled]="isLoading() || isUploading()"
              class="p-button-secondary w-full sm:w-auto"
            ></button>
            <button
              type="submit"
              pButton
              label="{{ isLoading() || isUploading() ? 'Salvando...' : 'Salvar' }}"
              [disabled]="tutorForm.invalid || isLoading() || isUploading()"
              class="w-full sm:w-auto"
            ></button>
          </div>
        </form>
      }
    </p-card>
  </div>
</div>

<p-dialog
  [(visible)]="showLinkDialog"
  header="Vincular Pet"
  [modal]="true"
  [style]="{ width: 'min(600px, 92vw)' }"
  (onHide)="closeLinkDialog()"
>
  <div class="space-y-4">
    <div>
      <label for="petSearch" class="field-label mb-2">
        Buscar Pet
      </label>
      <input
        id="petSearch"
        type="text"
        pInputText
        [value]="searchTermValue"
        (input)="onSearchChange($any($event.target).value)"
        placeholder="Digite o nome do pet..."
        class="w-full"
      />
    </div>

    @if (petsLoading()) {
      <div class="text-center py-8">
        <p class="text-gray-600">Carregando pets...</p>
      </div>
    } @else {
      <div class="max-h-96 overflow-y-auto space-y-2">
        @if (getAvailablePetsForLinking().length === 0) {
          <p class="text-gray-600 text-center py-8">
            Nenhum pet disponível para vincular.
          </p>
        } @else {
          @for (pet of getAvailablePetsForLinking(); track pet.id) {
            <div class="p-4 bg-white rounded-xl ring-1 ring-gray-200/70 flex items-center gap-4">
              <input
                type="checkbox"
                class="h-4 w-4"
                [checked]="isPetSelected(pet.id)"
                (change)="togglePetSelection(pet)"
              />
              <div class="flex items-center gap-4 flex-1">
                @if (pet.foto?.url) {
                  <img
                    [src]="pet.foto?.url"
                    [alt]="pet.nome"
                    class="w-12 h-12 rounded-full object-cover"
                  />
                }
                <div>
                  <h4 class="font-semibold text-gray-900">{{ pet.nome }}</h4>
                  <p class="text-sm text-gray-600">{{ pet.raca }}</p>
                </div>
              </div>
            </div>
          }
        }
      </div>
    }

    <div class="flex items-center justify-between gap-3 pt-4 border-t border-gray-200">
      <span class="text-sm text-gray-600">
        {{ selectedPets().length }} selecionado(s)
      </span>
      <div class="flex gap-2">
        <button
          type="button"
          pButton
          label="Cancelar"
          class="p-button-text"
          (click)="closeLinkDialog()"
          [disabled]="isLoading() || isUploading()"
        ></button>
        <button
          type="button"
          pButton
          label="Vincular selecionados"
          icon="pi pi-check"
          (click)="linkSelectedPets()"
          [disabled]="selectedPets().length === 0 || isLoading() || isUploading()"
        ></button>
      </div>
    </div>
  </div>
</p-dialog>
